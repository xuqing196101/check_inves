<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ses.dao.bms.CategoryParameterMapper">
	
	<!-- 品目对象 -->
	<resultMap id="CategoryMap" type="ses.model.bms.Category">
		<id column="ID" property="id" />
		<result column="NAME" property="name" />
		<result column="PARENT_ID" property="parentId" />
	</resultMap>
	
	<!-- 分类参数 -->
	<resultMap id="categoryParams" type="ses.model.bms.CategoryParameter">
		<id column="ID" property="id" />
		<result column="CATE_ID"  property="cateId"/>
		<result column="PARAM_NAME"  property="paramName"/>
		<result column="PARAM_TYPE_ID"  property="paramTypeId"/>
		<result column="IS_DELETED" property="isDeleted"/>
	</resultMap>
	
	<!-- 基础sql -->
	<sql id="parameter_sql" >
		ID, CATE_ID, PARAM_NAME,PARAM_TYPE_ID,IS_DELETED
	</sql>
	
	<!-- 查询tree -->
	<select id="findCategoryTree" resultMap="CategoryMap">
		SELECT A.ID AS id, A.NAME AS name, A.PARENT_ID AS parentId
		FROM T_SES_BMS_CATEGORY A, T_SES_BMS_CATE_ORG B
		WHERE A.ID = B.CATE_ID
		   AND A.IS_DELETED = '0'
		   AND B.ORG_ID = #{orgId}
	</select>
	
	<!-- 保存 -->
	<insert id="saveParameter" parameterType="ses.model.bms.CategoryParameter">
		<selectKey keyProperty="id" resultType="java.lang.String" order="BEFORE">
        	select sys_guid() from dual
    	</selectKey>
		INSERT INTO T_SES_BMS_CATEPARAMETER (ID,CATE_ID,ORG_ID,PARAM_NAME,PARAM_TYPE_ID,
			 IS_DELETED,CREATED_AT,UPDATED_AT) values 
			(#{id}, #{cateId,jdbcType=VARCHAR},#{orgId,jdbcType=VARCHAR}, #{paramName,jdbcType=VARCHAR},
			#{paramTypeId,jdbcType=VARCHAR},#{isDeleted,jdbcType=SMALLINT},#{createdAt,jdbcType=TIMESTAMP},
			#{updatedAt,jdbcType=TIMESTAMP})
	</insert>
	
	<!-- 更新 -->
	<update id="update" parameterType="ses.model.bms.CategoryParameter"> 
		UPDATE T_SES_BMS_CATEPARAMETER 
		SET UPDATED_AT = #{updatedAt}
		<if test="paramName != null and paramName !=''">
			,PARAM_NAME = #{paramName}
		</if>
		<if test="paramTypeId != null and paramTypeId !=''">
			,PARAM_TYPE_ID = #{paramTypeId}
		</if>
		<if test="isDeleted != null and isDeleted !=''">
			,IS_DELETED = #{isDeleted}
		</if>
		WHERE ID = #{id}
	</update>
	
	
	<!-- 删除 -->
	<delete id="delParameter">
		DELETE FROM T_SES_BMS_CATEPARAMETER
		where CATE_ID = #{cateId}
	</delete>
	
	<!-- 查询对应的参数 -->
	<select id="getParamsByCateId" resultMap="categoryParams">
		SELECT 
		<include refid="parameter_sql" />
		FROM  T_SES_BMS_CATEPARAMETER
		WHERE IS_DELETED = 0
		AND CATE_ID = #{cateId} ORDER BY CREATED_AT
	</select>
	
	<!-- 根据主键查询 -->
	<select id="getParameterById" resultMap="categoryParams">
		SELECT 
		<include refid="parameter_sql" />
		FROM T_SES_BMS_CATEPARAMETER
		WHERE IS_DELETED = 0
		AND ID= #{id}
	</select>
	
</mapper>